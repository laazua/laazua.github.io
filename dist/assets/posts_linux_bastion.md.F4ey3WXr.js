import{_ as i,o as a,c as e,ai as l}from"./chunks/framework.rV0OLpih.js";const r=JSON.parse('{"title":"SSH CA 堡垒机实验","description":"","frontmatter":{"title":"SSH CA 堡垒机实验","prev":{"text":"SSH CA使用示例教程","link":"./sshd-ca.md"},"next":{"text":"SSH CA 通用账号登录","link":"./ssh-ca.md"}},"headers":[],"relativePath":"posts/linux/bastion.md","filePath":"posts/linux/bastion.md"}'),n={name:"posts/linux/bastion.md"};function t(h,s,c,p,k,d){return a(),e("div",null,[...s[0]||(s[0]=[l(`<h5 id="基于openssl-ssh的堡垒机实现" tabindex="-1">基于OpenssL SSH的堡垒机实现 <a class="header-anchor" href="#基于openssl-ssh的堡垒机实现" aria-label="Permalink to “基于OpenssL SSH的堡垒机实现”">​</a></h5><h3 id="carl" tabindex="-1">carl <a class="header-anchor" href="#carl" aria-label="Permalink to “carl”">​</a></h3><ul><li><p>描述: carl: ca remote login</p></li><li><p>说明:</p><ol><li>ssh ca证书认证登录远程主机</li><li>carl 为CA服务, 提供证书颁发，管理等</li><li>carlctl 为客户端命令行工具, 部署在自己的节点上</li></ol></li><li><p>流程：</p><ul><li>CA服务器: <code>mkdir -p /etc/ssh/ca/user_rsa_pub</code></li><li>CA服务器创建ca公钥和私钥: <ol><li>方式一: <code>ssh-keygen -t rsa -b 4096 -f /etc/ssh/ca/ca -C &quot;SSH User CA&quot;</code></li><li>方式二: <code>ssh-keygen -t ed25519 -f /etc/ssh/ca/ca_ed25519 -C &quot;SSH User CA ED25519&quot;</code></li></ol></li><li>将CA公钥传递到被登录服务<code>注: 业务主机</code>(并进行相关sshd配置,重启sshd) <ol><li>业务主机: <code>mkdir -p /etc/ssh/ca</code></li><li>CA服务器: <code>scp ca.pub 业务主机:/etc/ssh/ca/user_key.pub</code></li><li>业务主机: <code>cat /etc/ssh/sshd_config.d/10-zhangsan.conf</code></li></ol><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 信任用户CA</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">TrustedUserCAKeys</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/ssh/ca/user_key.pub</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 信任主机CA（可选，增强安全性）</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#HostCertificate /etc/ssh/ssh_host_rsa_key-cert.pub</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 禁用密码认证（生产环境推荐）</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PasswordAuthentication</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> no</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ChallengeResponseAuthentication</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> no</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">UsePAM</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> no</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 允许证书认证</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PubkeyAuthentication</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> yes</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">AuthorizedKeysFile</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> .ssh/authorized_keys</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 日志级别</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">LogLevel</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> VERBOSE</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 证书相关选项</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 允许用户证书中的命令强制执行</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PermitUserRC</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> yes</span></span></code></pre></div></li><li>登录服务器<code>注: 堡垒机</code>生成用户密钥(并将用户公钥用户CA服务器的CA私钥进行签名,然后回传到登录服务器进行配置): <ol><li>堡垒机: <code>ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa_ca -C &quot;user-cert&quot;</code></li><li>堡垒机: <code>scp ~/.ssh/id_rsa_ca.pub CA服务器:/etc/ssh/ca/user_rsa_pub/zhangsan_id_rsa_ca.pub</code></li><li>CA服务器: <code>ssh-keygen -s /etc/ssh/ca/ca -I &quot;user_$(date +%Y%m%d)&quot; -n &quot;zhangsan&quot; -V +30d -z $(date +%Y%m%d%H%M%S) /etc/ssh/ca/user_rsa_pub/zhangsan_id_rsa_ca.pub</code></li><li>CA服务器: <code>scp /etc/ssh/ca/user_rsa_pub/zhangsan_rsa_ca-cert.pub 堡垒机:~/.ssh/id_rsa_ca-cert.pub</code></li><li>堡垒机用户登录ssh配置: <code>cat ~/.ssh/config</code></li></ol><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Host</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 192.168.165.73</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">HostName</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 192.168.165.73</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">User</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zhangsan</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">IdentityFile</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ~/.ssh/id_rsa_ca</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">CertificateFile</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ~/.ssh/id_rsa_ca-cert.pub</span></span></code></pre></div><ol start="6"><li>堡垒机进行登录测试</li></ol></li></ul></li><li><p>撤销认证</p><ul><li>KRL（Key Revocation List）文件方式: <ol><li>CA服务器: <code>KRL=/etc/ssh/ca/revoked.krl</code></li><li>CA服务器: <code>SERIALID=$(ssh-keygen -L -f /etc/ssh/ca/user_rsa_pub/zhangsan_rsa_ca-cert.pub | grep Serial|awk -F: &#39;{print $2}&#39;)</code></li><li>CA服务器: <code>ssh-keygen -k -u -f $KRL -z \${SERIALID}</code></li><li>CA服务器: 同步KRL: <code>scp \${KPL} 业务主机:\${KRL}</code></li><li>业务服务器: 配置sshd: <code>echo &quot;RevokedKeys /etc/ssh/ca/revoked.krl&quot; &gt;&gt; /etc/ssh/sshd_config.d/10-zhangsan.conf</code>; 重启sshd</li></ol></li><li>基于文件的撤销列表(RevokedKeys): <ol><li>CA服务器: <code>echo &quot;serial: $(ssh-keygen -L -f /etc/ssh/ca/user_rsa_pub/zhangsan_rsa_ca-cert.pub | grep Serial | awk &#39;{print $2}&#39;)&quot; &gt;&gt; /etc/ssh/ca/revoked_keys</code></li><li>CA服务器: 同步revoked_keys: <code>scp /etc/ssh/ca/revoked_keys 业务主机:/etc/ssh/ca/revoked_keys</code></li><li>业务主机: 配置sshd: <code>echo &quot;RevokedKeys /etc/ssh/ca/revoked_keys&quot; &gt; /etc/ssh/sshd_config.d/10-zhangsan.conf</code>; 重启sshd</li></ol></li></ul></li></ul>`,3)])])}const g=i(n,[["render",t]]);export{r as __pageData,g as default};
